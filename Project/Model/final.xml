<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.1//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_2.dtd'>
<nta>
	<declaration>
const int NODES = 10;                         //Total nodecount, including main node

typedef int[0,NODES-1] nodeId_t;              //Range of integers representing all nodes
typedef int[1,NODES-1] nonMainNodeId_t;       //Range of integers representing all non-main nodes.
typedef int[0,3] packetType_t;                //0: Error, 1: DataRequest, 2: Data, 3: DataAcknowledgement
const int error = 0;
const int dataRequest = 1;
const int data = 2;
const int dataAcknowledgement = 3;

nodeId_t auxId;                               //auxId for intermediate storage of "who's transmitting"

broadcast chan radio;                         //channel

packetType_t sharedPacketType[nodeId_t];      //packets
nodeId_t sharedPacketAddresser[nodeId_t];     //senderId
nodeId_t sharedPacketAddressee[nodeId_t];     //receiverId
nodeId_t sharedPacketSource[nodeId_t];        //original source
</declaration>
	<template>
		<name>Sensor</name>
		<parameter>const nodeId_t nodeId</parameter>
		<declaration>packetType_t localPacketType;      //packets
nodeId_t localPacketAddresser;     //senderId
nodeId_t localPacketAddressee;     //receiverId
nodeId_t localPacketSource;        //original source</declaration>
		<location id="id0" x="-170" y="-34">
			<name x="-187" y="-68">updateLastPacketTimer</name>
		</location>
		<location id="id1" x="918" y="-306">
			<name x="908" y="-340">waitingForForwardedDataAcknowledgement</name>
		</location>
		<location id="id2" x="646" y="-306">
			<name x="629" y="-340">relayingData</name>
		</location>
		<location id="id3" x="1190" y="-102">
			<name x="1180" y="-136">waitingAfterClear</name>
		</location>
		<location id="id4" x="918" y="-102">
			<name x="908" y="-136">waitingBetweenClears</name>
		</location>
		<location id="id5" x="646" y="-102">
		</location>
		<location id="id6" x="1190" y="-510">
			<name x="1180" y="-544">waitingToSendNextRequest</name>
		</location>
		<location id="id7" x="918" y="-510">
			<name x="908" y="-544">sendingDataRequest</name>
		</location>
		<location id="id8" x="646" y="-510">
			<name x="636" y="-544">waitingForDataAcknowledgement</name>
		</location>
		<location id="id9" x="374" y="102">
			<name x="364" y="68">handleErrorPacket</name>
		</location>
		<location id="id10" x="374" y="-102">
			<name x="364" y="-136">handleClearPacket</name>
		</location>
		<location id="id11" x="374" y="-306">
			<name x="364" y="-340">handleDataPacket</name>
		</location>
		<location id="id12" x="374" y="-510">
			<name x="364" y="-544">handleDataRequestPacket</name>
		</location>
		<location id="id13" x="102" y="-204">
			<name x="92" y="-238">handlePacket</name>
		</location>
		<location id="id14" x="-170" y="-204">
			<name x="-180" y="-238">listenForPacket</name>
		</location>
		<init ref="id14"/>
		<transition>
			<source ref="id9"/>
			<target ref="id14"/>
			<label kind="comments" x="17" y="119">knows parent, but no deadline is met.</label>
			<nail x="306" y="136"/>
			<nail x="-34" y="136"/>
		</transition>
		<transition>
			<source ref="id9"/>
			<target ref="id0"/>
			<label kind="comments" x="-85" y="153">knows parent, but no packet received for a long time. Clear self.</label>
			<nail x="340" y="170"/>
			<nail x="-68" y="170"/>
		</transition>
		<transition>
			<source ref="id9"/>
			<target ref="id0"/>
			<label kind="comments" x="76" y="187">doesn't know parent</label>
			<nail x="374" y="204"/>
			<nail x="-102" y="204"/>
		</transition>
		<transition>
			<source ref="id0"/>
			<target ref="id14"/>
		</transition>
		<transition>
			<source ref="id1"/>
			<target ref="id0"/>
			<label kind="comments" x="1198" y="-297">acknowledged, job's done.</label>
			<nail x="1496" y="-238"/>
			<nail x="1496" y="272"/>
			<nail x="-170" y="272"/>
		</transition>
		<transition>
			<source ref="id1"/>
			<target ref="id14"/>
			<label kind="comments" x="1198" y="-391">never acknowledged, clear self.</label>
			<nail x="1496" y="-374"/>
			<nail x="1496" y="-612"/>
			<nail x="-170" y="-612"/>
		</transition>
		<transition>
			<source ref="id1"/>
			<target ref="id2"/>
			<label kind="comments" x="680" y="-263">no acknowledgement received</label>
			<nail x="850" y="-272"/>
			<nail x="714" y="-272"/>
		</transition>
		<transition>
			<source ref="id2"/>
			<target ref="id1"/>
			<label kind="comments" x="705" y="-365">send packet to parent</label>
			<nail x="714" y="-340"/>
			<nail x="850" y="-340"/>
		</transition>
		<transition>
			<source ref="id11"/>
			<target ref="id2"/>
			<label kind="comments" x="450" y="-331">acknowledge sender</label>
		</transition>
		<transition>
			<source ref="id6"/>
			<target ref="id0"/>
			<nail x="1462" y="-510"/>
			<nail x="1462" y="238"/>
			<nail x="-136" y="238"/>
		</transition>
		<transition>
			<source ref="id6"/>
			<target ref="id10"/>
			<label kind="comments" x="756" y="-433">clear modtaget</label>
			<nail x="1190" y="-442"/>
			<nail x="374" y="-442"/>
			<nail x="306" y="-374"/>
			<nail x="306" y="-170"/>
		</transition>
		<transition>
			<source ref="id3"/>
			<target ref="id0"/>
			<nail x="1530" y="-102"/>
			<nail x="1530" y="306"/>
			<nail x="-204" y="306"/>
		</transition>
		<transition>
			<source ref="id4"/>
			<target ref="id3"/>
		</transition>
		<transition>
			<source ref="id4"/>
			<target ref="id5"/>
			<label kind="comments" x="722" y="-59">more clears to send</label>
			<nail x="850" y="-68"/>
			<nail x="714" y="-68"/>
		</transition>
		<transition>
			<source ref="id5"/>
			<target ref="id4"/>
			<label kind="comments" x="722" y="-161">send clearPacket</label>
			<nail x="714" y="-136"/>
			<nail x="850" y="-136"/>
		</transition>
		<transition>
			<source ref="id10"/>
			<target ref="id5"/>
			<label kind="comments" x="450" y="-127">reset variables</label>
		</transition>
		<transition>
			<source ref="id6"/>
			<target ref="id7"/>
			<label kind="comments" x="935" y="-467">vi mangler at sende flere requests</label>
			<nail x="1122" y="-476"/>
			<nail x="986" y="-476"/>
		</transition>
		<transition>
			<source ref="id7"/>
			<target ref="id6"/>
			<label kind="comments" x="986" y="-569">broadcast request</label>
			<nail x="986" y="-544"/>
			<nail x="1122" y="-544"/>
		</transition>
		<transition>
			<source ref="id8"/>
			<target ref="id7"/>
			<label kind="comments" x="680" y="-535">acknowledgement modtaget</label>
		</transition>
		<transition>
			<source ref="id8"/>
			<target ref="id12"/>
			<label kind="comments" x="450" y="-467">ingen acknowledgement modtaget</label>
			<nail x="578" y="-476"/>
			<nail x="442" y="-476"/>
		</transition>
		<transition>
			<source ref="id12"/>
			<target ref="id8"/>
			<label kind="comments" x="450" y="-569">send packet til parent</label>
			<nail x="442" y="-544"/>
			<nail x="578" y="-544"/>
		</transition>
		<transition>
			<source ref="id10"/>
			<target ref="id14"/>
			<label kind="comments" x="-59" y="-127">vi er allerede clearet</label>
			<nail x="-68" y="-102"/>
		</transition>
		<transition>
			<source ref="id11"/>
			<target ref="id14"/>
			<label kind="comments" x="-59" y="-331">data er ikke addreseret til os, eller kender ikke parent</label>
			<nail x="-68" y="-306"/>
		</transition>
		<transition>
			<source ref="id12"/>
			<target ref="id14"/>
			<label kind="comments" x="-59" y="-535">kender allerede en parent eller packets levetid er udløbet</label>
			<nail x="-102" y="-510"/>
		</transition>
		<transition>
			<source ref="id13"/>
			<target ref="id9"/>
			<nail x="221" y="-153"/>
		</transition>
		<transition>
			<source ref="id13"/>
			<target ref="id10"/>
			<nail x="238" y="-187"/>
		</transition>
		<transition>
			<source ref="id13"/>
			<target ref="id11"/>
			<nail x="238" y="-221"/>
		</transition>
		<transition>
			<source ref="id13"/>
			<target ref="id12"/>
			<nail x="221" y="-255"/>
		</transition>
		<transition>
			<source ref="id14"/>
			<target ref="id13"/>
			<label kind="comments" x="-187" y="-229">Packet modtaget eller listenFor timeout mødt</label>
			<nail x="-102" y="-204"/>
			<nail x="34" y="-204"/>
		</transition>
	</template>
	<template>
		<name x="5" y="5">Main</name>
		<parameter>const nodeId_t nodeId</parameter>
		<declaration>clock totalTimeElapsed;
clock timeElapsed;

const int totalDeadline = 10000;
int requestsToSend;
int clearsToSend;

packetType_t localPacketType;      //packets
nodeId_t localPacketAddresser;     //senderId
nodeId_t localPacketAddressee;     //receiverId
nodeId_t localPacketSource;        //original source

bool receivedData[nonMainNodeId_t];

bool receivedAllData()
{
    for (i : nonMainNodeId_t)
    {
        if (!receivedData[i])
        {
            return false;
        }
    }
    return true;
}</declaration>
		<location id="id15" x="850" y="408">
			<committed/>
		</location>
		<location id="id16" x="1802" y="102">
			<committed/>
		</location>
		<location id="id17" x="340" y="68">
			<committed/>
		</location>
		<location id="id18" x="2134" y="102">
			<name x="2040" y="119">doneHandlingDataPacket</name>
		</location>
		<location id="id19" x="1130" y="442">
			<name x="1120" y="408">waiting</name>
			<urgent/>
		</location>
		<location id="id20" x="578" y="442">
			<name x="510" y="476">sendClearSignals</name>
		</location>
		<location id="id21" x="1462" y="102">
			<name x="1402" y="0">handleDataPacket</name>
		</location>
		<location id="id22" x="2134" y="442">
			<name x="2124" y="408">done</name>
		</location>
		<location id="id23" x="1130" y="102">
			<name x="1079" y="51">handlePacket</name>
		</location>
		<location id="id24" x="578" y="102">
			<name x="527" y="59">listenForPacket</name>
			<urgent/>
		</location>
		<location id="id25" x="102" y="102">
			<name x="51" y="59">sendRequests</name>
		</location>
		<location id="id26" x="-204" y="102">
			<name x="-221" y="59">start</name>
		</location>
		<init ref="id26"/>
		<transition>
			<source ref="id15"/>
			<target ref="id19"/>
			<label kind="synchronisation" x="926" y="382">radio!</label>
			<nail x="1054" y="408"/>
		</transition>
		<transition>
			<source ref="id16"/>
			<target ref="id18"/>
			<label kind="synchronisation" x="1938" y="76">radio!</label>
		</transition>
		<transition>
			<source ref="id17"/>
			<target ref="id24"/>
			<label kind="synchronisation" x="399" y="42">radio!</label>
			<nail x="510" y="68"/>
		</transition>
		<transition>
			<source ref="id18"/>
			<target ref="id24"/>
			<label kind="comments" x="1360" y="-178">data er handlet</label>
			<nail x="2074" y="-136"/>
			<nail x="646" y="-136"/>
		</transition>
		<transition>
			<source ref="id21"/>
			<target ref="id16"/>
			<label kind="assignment" x="1487" y="25">sharedPacketType[nodeId] = dataAcknowledgement,
sharedPacketAddresser[nodeId] = nodeId,
sharedPacketAddressee[nodeId] = localPacketAddresser,
auxId = nodeId</label>
			<label kind="comments" x="1717" y="0">broadcast acknowledgement</label>
		</transition>
		<transition>
			<source ref="id19"/>
			<target ref="id22"/>
			<label kind="guard" x="1564" y="416">clearsToSend &lt;= 0</label>
			<label kind="comments" x="1513" y="391">ikke flere clearsignals at sende</label>
		</transition>
		<transition>
			<source ref="id19"/>
			<target ref="id20"/>
			<label kind="guard" x="722" y="510">clearsToSend &gt; 0 &amp;&amp; timeElapsed &gt; 1000</label>
			<label kind="comments" x="739" y="484">more clears to send and waiting done</label>
			<nail x="1062" y="476"/>
			<nail x="646" y="476"/>
		</transition>
		<transition>
			<source ref="id20"/>
			<target ref="id15"/>
			<label kind="assignment" x="663" y="331">sharedPacketType[nodeId] = dataAcknowledgement,
clearsToSend--,
auxId = nodeId,
timeElapsed := 0</label>
			<label kind="comments" x="790" y="306">broadcast clears</label>
			<nail x="646" y="408"/>
		</transition>
		<transition>
			<source ref="id24"/>
			<target ref="id20"/>
			<label kind="guard" x="586" y="255">receivedAllData() || totalTimeElapsed &gt; totalDeadline</label>
			<label kind="comments" x="586" y="229">har data fra alle kendte knuder, eller har ramt timeout</label>
		</transition>
		<transition>
			<source ref="id23"/>
			<target ref="id24"/>
			<label kind="guard" x="654" y="170">localPacketType != data</label>
			<label kind="comments" x="654" y="144">packet ikke af typen data</label>
			<nail x="1062" y="136"/>
			<nail x="646" y="136"/>
		</transition>
		<transition>
			<source ref="id23"/>
			<target ref="id21"/>
			<label kind="guard" x="1198" y="76">localPacketType == data</label>
			<label kind="comments" x="1198" y="51">packet har typen "data"</label>
		</transition>
		<transition>
			<source ref="id24"/>
			<target ref="id23"/>
			<label kind="synchronisation" x="654" y="-26">radio?</label>
			<label kind="assignment" x="654" y="-9">localPacketType = sharedPacketType[auxId],
localPacketAddresser = sharedPacketAddresser[auxId],
localPacketAddressee = sharedPacketAddressee[auxId],
localPacketSource = sharedPacketSource[auxId]</label>
			<label kind="comments" x="654" y="-51">packet modtaget</label>
			<nail x="654" y="68"/>
			<nail x="1062" y="68"/>
		</transition>
		<transition>
			<source ref="id24"/>
			<target ref="id25"/>
			<label kind="guard" x="195" y="170">requestsToSend &gt; 0 &amp;&amp; timeElapsed &gt; 1000</label>
			<label kind="comments" x="195" y="144">timeout and more requests to send</label>
			<nail x="510" y="136"/>
			<nail x="170" y="136"/>
		</transition>
		<transition>
			<source ref="id25"/>
			<target ref="id17"/>
			<label kind="assignment" x="195" y="-9">sharedPacketType[nodeId] = dataRequest,
requestsToSend--,
auxId = nodeId,
timeElapsed := 0</label>
			<label kind="comments" x="195" y="-34">broadcast request</label>
			<nail x="170" y="68"/>
		</transition>
		<transition>
			<source ref="id26"/>
			<target ref="id25"/>
			<label kind="assignment" x="-144" y="42">requestsToSend = 12,
clearsToSend = 12,
totalTimeElapsed := 0</label>
			<label kind="comments" x="-144" y="17">modtager signal til start</label>
		</transition>
	</template>
	<system>main = Main(0);
sensors(const nonMainNodeId_t id) = Sensor(id);

system main, sensors;
</system>
	<queries>
	</queries>
</nta>
